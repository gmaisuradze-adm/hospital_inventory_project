{% extends "core/base.html" %}
{% load static i18n %}

{% block page_header_title %}
    {{ page_title }}
{% endblock page_header_title %}

{% block page_header_subtitle %}
    {% if welcome_message %}
        <div class="text-muted mt-1">{{ welcome_message }}</div>
    {% endif %}
{% endblock page_header_subtitle %}

{% block content %}
    {% if dashboard_error %}
    <div class="alert alert-danger" role="alert">
        <h4 class="alert-title">{% trans "შეცდომა მოხდა" %}</h4>
        <div class="text-muted">{{ dashboard_error }}</div>
    </div>
    {% endif %}

    {% if user.is_staff %}
        {# ADMIN DASHBOARD CONTENT - STAT CARDS #}
        <div class="row row-deck row-cards">
            {# Card 1: New Requests #}
            <div class="col-sm-6 col-lg-3">
                <a href="{{ new_requests_url|default:'#' }}" class="card card-link card-link-pop">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <span class="bg-primary text-white avatar">
                                    <i class="ti ti-bell-plus icon-lg"></i>
                                </span>
                            </div>
                            <div class="col">
                                <div class="font-weight-medium">
                                    {{ new_requests_count|default:"0" }} {% trans "ახალი მოთხოვნები" %}
                                </div>
                                <div class="text-muted">
                                    {{ unassigned_requests_count|default:"0" }} {% trans "არ არის გაწევრილი" %}
                                    (<span class="text-primary">{% trans "ნახვა" %}</span>)
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </div>

            {# Card 2: Active Requests (In Progress + On Hold) #}
            <div class="col-sm-6 col-lg-3">
                <a href="{{ active_requests_url|default:'#' }}" class="card card-link card-link-pop">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <span class="bg-azure text-white avatar">
                                    <i class="ti ti-loader icon-lg"></i>
                                </span>
                            </div>
                            <div class="col">
                                <div class="font-weight-medium">
                                    {{ active_requests_count|default:"0" }} {% trans "აქტიური მოთხოვნები" %}
                                </div>
                                <div class="text-muted">
                                   {% trans "მუშაობაში" %}: {{ in_progress_requests_count|default:"0" }}, {% trans "შეჩერებული" %}: {{ on_hold_requests_count|default:"0" }}
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </div>

            {# Card 3: Total Equipment #}
            <div class="col-sm-6 col-lg-3">
                <a href="{{ total_equipment_url|default:'#' }}" class="card card-link card-link-pop">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <span class="bg-success text-white avatar">
                                    <i class="ti ti-building-warehouse icon-lg"></i>
                                </span>
                            </div>
                            <div class="col">
                                <div class="font-weight-medium">
                                    {{ total_equipment|default:"0" }} {% trans "მთელი ტექნიკა" %}
                                </div>
                                <div class="text-muted">
                                    {% trans "ინვენტარის ნახვა" %}
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </div>

            {# Card 4: Total Stock Items #}
            <div class="col-sm-6 col-lg-3">
                 <a href="{{ total_stock_items_url|default:'#' }}" class="card card-link card-link-pop">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <span class="bg-warning text-white avatar">
                                    <i class="ti ti-packages icon-lg"></i>
                                </span>
                            </div>
                            <div class="col">
                                <div class="font-weight-medium">
                                    {{ total_stock_items|default:"0" }} {% trans "საწყობის ნივთები" %}
                                </div>
                                <div class="text-muted">
                                    {% trans "საწყობის ნახვა" %}
                                </div>
                            </div>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        {# Charts and Recent Activity Row #}
        <div class="row row-deck row-cards mt-4">
            <div class="col-lg-7">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">{% trans "ბოლო აქტიური მოთხოვნები" %}</h3>
                    </div>
                    <div class="list-group list-group-flush list-group-hoverable overflow-auto" style="max-height: 380px">
                        {% for req in staff_recent_active_requests %}
                            <div class="list-group-item">
                                <div class="row align-items-center">
                                    <div class="col-auto">
                                        {% if req.get_status_badge_class %}
                                            <span class="badge bg-{{ req.get_status_badge_class }}-lt">{{ req.get_status_display }}</span>
                                        {% elif req.status == 'new' %}
                                            <span class="badge bg-primary-lt">{% trans "ახალი" %}</span>
                                        {% elif req.status == 'assigned' or req.status == 'in_progress' %}
                                            <span class="badge bg-info-lt">{% trans "მუშაობაში" %}</span>
                                        {% elif req.status == 'on_hold' %}
                                            <span class="badge bg-warning-lt">{% trans "შეჩერებული" %}</span>
                                        {% else %}
                                            <span class="badge bg-secondary-lt">{{ req.get_status_display }}</span>
                                        {% endif %}
                                    </div>
                                    <div class="col text-truncate">
                                        <a href="{% url 'requests_app:request_detail' req.id %}" class="text-reset d-block fw-bold">#{{ req.id }}: {{ req.subject|default:req.description|truncatechars:40 }}</a>
                                        <div class="d-block text-muted text-truncate mt-n1">
                                            {% if req.request_type %}
                                                <span class="text-muted small me-2">
                                                    <i class="ti ti-tag"></i> {{ req.request_type.name|default:"N/A" }}
                                                </span>
                                            {% endif %}
                                            {% if req.priority %}
                                                {% if req.priority == 'high' %}
                                                    <span class="badge bg-danger-lt small me-2">
                                                        <i class="ti ti-alert-triangle"></i> {{ req.get_priority_display }}
                                                    </span>
                                                {% elif req.priority == 'critical' %}
                                                    <span class="badge bg-red-lt small me-2">
                                                        <i class="ti ti-alert-octagon"></i> {{ req.get_priority_display }}
                                                    </span>
                                                {% elif req.priority == 'medium' %}
                                                    <span class="badge bg-yellow-lt small me-2">
                                                        <i class="ti ti-flame"></i> {{ req.get_priority_display }}
                                                    </span>
                                                {% elif req.priority == 'low' %}
                                                    <span class="badge bg-green-lt small me-2">
                                                        <i class="ti ti-arrow-down"></i> {{ req.get_priority_display }}
                                                    </span>
                                                {% else %}
                                                    <span class="badge bg-secondary-lt small me-2">{{ req.get_priority_display }}</span>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                        <div class="d-block text-muted text-truncate mt-1">
                                            {% blocktrans with user_val=req.requested_by.username|default:req.requested_by.get_full_name time_ago_val=req.updated_at|timesince %}
                                            მაშვრის: {{ user_val }} - {{ time_ago_val }} წინ.
                                            {% endblocktrans %}
                                            {% if req.assigned_to %}
                                                გაწევრილია: {{ req.assigned_to.username|default:req.assigned_to.get_full_name }}
                                            {% else %}
                                                <span class="text-danger">{% trans "არ არის გაწევრილი" %}</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                         <a href="{% url 'requests_app:request_detail' req.id %}" class="btn btn-sm btn-outline-primary">{% trans "ნახვა" %}</a>
                                    </div>
                                </div>
                            </div>
                        {% empty %}
                            <div class="list-group-item">
                                <p class="text-muted text-center py-3">{% trans "ბოლო აქტიური მოთხოვნები არ მოიძებნა." %}</p>
                            </div>
                        {% endfor %}
                    </div>
                    {% if staff_recent_active_requests.count > 0 %}
                    <div class="card-footer text-center">
                        <a href="{% url 'requests_app:admin_request_list' %}" class="btn btn-primary">
                            <i class="ti ti-list-details me-1"></i>{% trans "ყველა მოთხოვნის ნახვა" %}
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">{% trans "აქტიური მოთხოვნების სტატუსები" %}</h3>
                    </div>
                    <div class="card-body">
                        {% if request_status_chart_data.series|length > 0 and request_status_chart_data.series.0 != 'N/A' %}
                            <div id="chart-request-statuses" class="chart-lg">
                                <p class="text-muted text-center small py-5"><em>{% trans "დიაგრამა იტვირთება ან JavaScript-ის პრობლემა..." %}</em></p>
                            </div>
                        {% else %}
                            <p class="text-muted text-center">{% trans "დიაგრამისთვის მონაცემები არ არის ხელმისაწვდომი." %}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        {# ADVANCED ANALYTICS SECTION #}
        <div class="row row-deck row-cards mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-chart-line me-2"></i>{% trans "მოთხოვნების ანალიტიკა" %}
                        </h3>
                        <div class="card-actions">
                            <div class="dropdown">
                                <a href="#" class="btn btn-outline-primary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                                    <i class="ti ti-calendar me-1"></i>ბოლო 30 დღე
                                </a>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="#" onclick="updateChart('7days')">ბოლო 7 დღე</a>
                                    <a class="dropdown-item active" href="#" onclick="updateChart('30days')">ბოლო 30 დღე</a>
                                    <a class="dropdown-item" href="#" onclick="updateChart('90days')">ბოლო 90 დღე</a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col">
                                <div class="row g-2">
                                    <div class="col-auto">
                                        <div class="text-center">
                                            <div class="text-h3 text-primary">{{ requests_completed_week|default:"0" }}</div>
                                            <div class="text-muted small">{% trans "დასრულებული" %}</div>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="text-center">
                                            <div class="text-h3 text-info">{{ active_requests_count|default:"0" }}</div>
                                            <div class="text-muted small">{% trans "მუშაობაში" %}</div>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="text-center">
                                            <div class="text-h3 text-warning">{{ new_requests_count|default:"0" }}</div>
                                            <div class="text-muted small">{% trans "ახალი" %}</div>
                                        </div>
                                    </div>
                                    <div class="col-auto">
                                        <div class="text-center">
                                            <div class="text-h3 text-muted">{{ total_requests_week|default:"0" }}</div>
                                            <div class="text-muted small">{% trans "სულ" %}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="requestsChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-device-analytics me-2"></i>{% trans "ტექნიკის სტატუსი" %}
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="chart-container mb-3" style="height: 200px;">
                            <canvas id="equipmentStatusChart"></canvas>
                        </div>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-success-lt badge-circle me-2"></span>
                                    <div>
                                        <div class="fw-bold">{{ operational_equipment_count|default:"0" }}</div>
                                        <div class="text-muted small">{% trans "მუშაობს" %}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-warning-lt badge-circle me-2"></span>
                                    <div>
                                        <div class="fw-bold">{{ maintenance_equipment_count|default:"0" }}</div>
                                        <div class="text-muted small">{% trans "შეკეთება" %}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-danger-lt badge-circle me-2"></span>
                                    <div>
                                        <div class="fw-bold">{{ broken_equipment_count|default:"0" }}</div>
                                        <div class="text-muted small">{% trans "გაფუჭებული" %}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-secondary-lt badge-circle me-2"></span>
                                    <div>
                                        <div class="fw-bold">{{ retired_equipment_count|default:"0" }}</div>
                                        <div class="text-muted small">{% trans "მოიხსნა" %}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        {# PERFORMANCE METRICS SECTION #}
        <div class="row row-deck row-cards mb-4">
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-clock-hour-3 me-2"></i>{% trans "რეაგირების დრო" %}
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <div class="chart-sparkline-square" id="responseTimeChart"></div>
                            </div>
                            <div class="col">
                                <div class="text-h2 mb-1">{{ avg_response_time|default:"2.4" }}სთ</div>
                                <div class="text-muted">
                                    {% trans "საშუალო რეაგირების დრო" %}
                                    <span class="text-success">
                                        <i class="ti ti-trending-down"></i>
                                        -12%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-target me-2"></i>{% trans "გადაწყვეტის მაჩვენებელი" %}
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <div class="chart-sparkline-square" id="resolutionRateChart"></div>
                            </div>
                            <div class="col">
                                <div class="text-h2 mb-1">{{ resolution_rate|default:"94" }}%</div>
                                <div class="text-muted">
                                    {% trans "წარმატებით გადაწყვეტილი" %}
                                    <span class="text-success">
                                        <i class="ti ti-trending-up"></i>
                                        +3%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="ti ti-users-group me-2"></i>{% trans "გუნდის ეფექტურობა" %}
                        </h3>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <div class="chart-sparkline-square" id="teamEfficiencyChart"></div>
                            </div>
                            <div class="col">
                                <div class="text-h2 mb-1">{{ team_efficiency|default:"87" }}%</div>
                                <div class="text-muted">
                                    {% trans "გუნდის საერთო მოქმედება" %}
                                    <span class="text-info">
                                        <i class="ti ti-minus"></i>
                                        0%
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    {% else %}
        {# USER DASHBOARD CONTENT #}
        <div class="px-4 py-5 my-5 text-center">
            <img class="d-block mx-auto mb-4" src="{% static 'core/images/hospital-logo.png' %}" alt="{% trans 'საავადმყოფოს ლოგო' %}" width="72" height="auto">
            <div class="col-lg-8 mx-auto">
                <p class="lead mb-4">{% trans "აქედან შეგიძლიათ ნახოთ ხელმისაწვდომი IT რესურსები, შეამოწმოთ თქვენი არსებული მოთხოვნები, ან წარადგინოთ ახლები." %}</p>
                <hr>
                <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                    <a href="{% url 'inventory:equipment_list' %}" class="btn btn-primary btn-lg px-4 gap-3">
                        <i class="ti ti-building-warehouse me-1"></i>{% trans "IT ინვენტარის ნახვა" %}
                    </a>
                    <a href="{% url 'requests_app:user_request_list' %}" class="btn btn-info btn-lg px-4">
                        <i class="ti ti-ticket me-1"></i>{% trans "ჩემი IT მოთხოვნები" %} ({{ my_open_requests_count|default:0 }})
                    </a>
                    <a href="{% url 'requests_app:request_create' %}" class="btn btn-success btn-lg px-4">
                        <i class="ti ti-plus me-1"></i>{% trans "ახალი მოთხოვნის შექმნა" %}
                    </a>
                </div>
            </div>
        </div>

        {% if my_recent_requests %}
        <div class="card mt-4">
            <div class="card-header">
                <h3 class="card-title">{% trans "ჩემი ბოლო მოთხოვნები" %}</h3>
            </div>
            <div class="list-group list-group-flush list-group-hoverable overflow-auto" style="max-height: 350px">
                {% for req in my_recent_requests %}
                    <div class="list-group-item">
                        <div class="row align-items-center">
                             <div class="col-auto">
                                {% if req.get_status_badge_class %}
                                    <span class="badge bg-{{ req.get_status_badge_class }}-lt">{{ req.get_status_display }}</span>
                                {% elif req.status == 'new' %}
                                    <span class="badge bg-primary-lt">{% trans "ახალი" %}</span>
                                {% elif req.status == 'assigned' or req.status == 'in_progress' %}
                                    <span class="badge bg-info-lt">{% trans "მუშაობაში" %}</span>
                                {% elif req.status == 'on_hold' %}
                                    <span class="badge bg-warning-lt">{% trans "შეჩერებული" %}</span>
                                {% elif req.status == 'resolved' or req.status == 'completed' %}
                                    <span class="badge bg-success-lt">{% trans "მოგვარებული" %}</span>
                                {% elif req.status == 'closed' %}
                                    <span class="badge bg-secondary-lt">{% trans "დახურული" %}</span>
                                {% elif req.status == 'cancelled' %}
                                    <span class="badge bg-danger-lt">{% trans "გაუქმებული" %}</span>
                                {% else %}
                                    <span class="badge bg-dark-lt">{{ req.get_status_display }}</span>
                                {% endif %}
                             </div>
                            <div class="col text-truncate">
                                <a href="{% url 'requests_app:request_detail' req.id %}" class="text-reset d-block">#{{ req.id }}: {{ req.subject|default:req.description|truncatechars:45 }}</a>
                                <div class="d-block text-muted text-truncate mt-n1 small">
                                    {% if req.request_type %}
                                        <span class="me-2"><i class="ti ti-tag"></i> {{ req.request_type.name|default:"N/A" }}</span>
                                    {% endif %}
                                    {% if req.priority %}
                                        <span><i class="ti ti-flag"></i> {{ req.get_priority_display }}</span>
                                    {% endif %}
                                </div>
                                <div class="d-block text-muted text-truncate mt-1">
                                    {% blocktrans with time_created=req.created_at|timesince time_updated=req.updated_at|timesince %}
                                    შექმნილია: {{ time_created }} წინ. განახლებულია: {{ time_updated }} წინ.
                                    {% endblocktrans %}
                                </div>
                            </div>
                             <div class="col-auto">
                                 <a href="{% url 'requests_app:request_detail' req.id %}" class="btn btn-sm btn-outline-primary">{% trans "ნახვა" %}</a>
                            </div>
                        </div>
                    </div>
                {% empty %}
                     <div class="list-group-item">
                        <p class="text-muted text-center py-3">{% trans "თქვენ არ გაქვთ ბოლო მოთხოვნები." %}</p>
                    </div>
                {% endfor %}
            </div>
            {% if my_recent_requests.count > 0 %}
            <div class="card-footer text-center">
                <a href="{% url 'requests_app:user_request_list' %}" class="btn btn-primary">
                     <i class="ti ti-list-check me-1"></i>{% trans "ჩემი ყველა მოთხოვნის ნახვა" %}
                </a>
            </div>
            {% endif %}
        </div>
        {% endif %}
    {% endif %}
{% endblock %}

{% block extra_js_scripts %}
    {% if user.is_staff and request_status_chart_data.series|length > 0 and request_status_chart_data.series.0 != 'N/A' %}
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        try {
            var options = {
              series: {{ request_status_chart_data.series|safe }},
              chart: { 
                type: 'donut', 
                height: 300,
                sparkline: { enabled: false }
              },
              labels: {{ request_status_chart_data.labels|safe }},
              colors: ['#206bc4', '#4299e1', '#f59e0b'],
              legend: { 
                position: 'bottom', 
                horizontalAlign: 'center' 
              },
              tooltip: { 
                y: { 
                  formatter: function (val) { 
                    return val + " {% trans "მოთხოვნები" %}" 
                  } 
                } 
              },
              responsive: [{ 
                breakpoint: 480, 
                options: { 
                  chart: { width: 200 }, 
                  legend: { position: 'bottom' } 
                } 
              }]
            };

            var chartElement = document.querySelector("#chart-request-statuses");
            if (chartElement && typeof ApexCharts !== 'undefined') {
                chartElement.innerHTML = ''; 
                var chart = new ApexCharts(chartElement, options);
                chart.render();
            } else {
                if (!chartElement) {
                    console.warn("Target element #chart-request-statuses not found.");
                }
                if (typeof ApexCharts === 'undefined') {
                    console.warn("ApexCharts library not defined. Check if it's loaded correctly in base.html.");
                    if(chartElement) { 
                        chartElement.innerHTML = "<p class='text-danger text-center small py-3'>{% trans "დიაგრამის ბიბლიოთეკა (ApexCharts) არ არის ჩატვირთული." %}</p>";
                    }
                }
            }
        } catch (e) {
            console.error("Error rendering ApexChart:", e);
            var chartDiv = document.querySelector("#chart-request-statuses"); 
            if (chartDiv) {
                chartDiv.innerHTML = "<p class='text-danger text-center small py-3'>{% trans "შეცდომა დიაგრამის რენდერისას. დეტალებისთვის მიმართეთ კონსოლს." %}</p>";
            }
        }
      });
    </script>
    {% endif %}
    
    {% if user.is_staff %}
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        try {
            const requestsChartElement = document.getElementById('requestsChart');
            if (requestsChartElement && typeof Chart !== 'undefined') {
                const ctx = requestsChartElement.getContext('2d');
                const requestsChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: {{ requests_chart_data.labels|safe }},
                        datasets: [{
                            label: '{% trans "მოთხოვნები" %}',
                            data: {{ requests_chart_data.data|safe }},
                            borderColor: '#206bc4',
                            backgroundColor: 'rgba(32, 107, 196, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                            }
                        },
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: '{% trans "თარიღი" %}'
                                },
                                grid: {
                                    display: true,
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: '{% trans "მოთხოვნების რაოდენობა" %}'
                                },
                                beginAtZero: true,
                                grid: {
                                    display: true,
                                    color: 'rgba(0, 0, 0, 0.1)'
                                }
                            }
                        }
                    }
                });
            } else {
                console.warn('Chart.js not loaded or requestsChart element not found');
                if (requestsChartElement) {
                    requestsChartElement.innerHTML = '<p class="text-muted text-center py-5">დიაგრამის ბიბლიოთეკა არ არის ხელმისაწვდომი</p>';
                }
            }

            const equipmentChartElement = document.getElementById('equipmentStatusChart');
            if (equipmentChartElement && typeof Chart !== 'undefined') {
                const equipmentCtx = equipmentChartElement.getContext('2d');
                const equipmentChart = new Chart(equipmentCtx, {
                    type: 'doughnut',
                    data: {
                        labels: {{ equipment_chart_data.labels|safe }},
                        datasets: [{
                            data: {{ equipment_chart_data.data|safe }},
                            backgroundColor: [
                                '#198754',
                                '#fd7e14',
                                '#dc3545',
                                '#6c757d'
                            ],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.formattedValue + ' ნივთი';
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                console.warn('Chart.js not loaded or equipmentStatusChart element not found');
                if (equipmentChartElement) {
                    equipmentChartElement.innerHTML = '<p class="text-muted text-center py-5">დიაგრამის ბიბლიოთეკა არ არის ხელმისაწვდომი</p>';
                }
            }

            const sparklineConfigs = [
                {
                    id: 'responseTimeChart',
                    data: [2.8, 2.5, 2.3, 2.6, 2.4, 2.1, 2.0],
                    color: '#206bc4'
                },
                {
                    id: 'resolutionRateChart', 
                    data: [88, 91, 89, 94, 92, 95, 94],
                    color: '#198754'
                },
                {
                    id: 'teamEfficiencyChart',
                    data: [85, 87, 86, 88, 87, 89, 87],
                    color: '#0dcaf0'
                }
            ];

            sparklineConfigs.forEach(config => {
                const element = document.getElementById(config.id);
                if (element && typeof Chart !== 'undefined') {
                    const ctx = element.getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['', '', '', '', '', '', ''],
                            datasets: [{
                                data: config.data,
                                borderColor: config.color,
                                backgroundColor: config.color + '20',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4,
                                pointRadius: 0,
                                pointHoverRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                tooltip: { enabled: false }
                            },
                            scales: {
                                x: { display: false },
                                y: { display: false }
                            },
                            elements: {
                                point: { radius: 0 }
                            }
                        }
                    });
                }
            });

        } catch (e) {
            console.error("Error initializing advanced analytics charts:", e);
        }

        window.updateChart = function(period) {
            console.log('Updating chart for period:', period);
        };
      });
    </script>
    {% endif %}
{% endblock %}
